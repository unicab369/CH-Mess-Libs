//------------------------------------------------------------------------------
//       Filename: nvs.c
//------------------------------------------------------------------------------
//       Bogdan Ionescu (c) 2024
//------------------------------------------------------------------------------
//       Purpose : Implements the nvs API
//------------------------------------------------------------------------------
//       Notes : None
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Module includes
//------------------------------------------------------------------------------
#include "nvs.h"
#include "ch32v003_flash.h"
// #include "log.h"

//------------------------------------------------------------------------------
// Module constant defines
//------------------------------------------------------------------------------
#define TAG           "nvs"
#define NVS_PAGE_SIZE (64)

//------------------------------------------------------------------------------
// External variables
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// External functions
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Module type definitions
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Module static variables
//------------------------------------------------------------------------------
static uint32_t nvs_page_start = 0;

//------------------------------------------------------------------------------
// Module static function prototypes
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Module externally exported functions
//------------------------------------------------------------------------------

void NVS_Init(void) {
    flash_set_latency();
    nvs_page_start = flash_calculate_runtime_address(0);
    // LOGD(TAG, "NVS page start: 0x%08X", nvs_page_start);
}

void NVS_Save(u8 *data, size_t size) {
    if (size > NVS_PAGE_SIZE) {
        // LOGE(TAG, "Cannot save data, size %d is too big", size);
        return;
    }
    flash_unlock();
    // LOGD(TAG, "Memory unlocked");

    // LOGD(TAG, "Erasing 64b page");
    flash_erase_page(nvs_page_start);
    // LOGD(TAG, "Memory erased");

    // LOGW(TAG, "Writing %d bytes", size);
    for (size_t i = 0; i < size; i += 2) {
        const u16 value = data[i] | (data[i + 1] << 8);
        flash_program_16(nvs_page_start + i, value);
    }
    // LOGD(TAG, "Memory written");

    flash_lock();
    // LOGD(TAG, "Memory locked");
}

void NVS_Load(u8 *data, size_t offset, size_t size) {
    if (offset + size > NVS_PAGE_SIZE) {
        // LOGE(TAG, "Cannot load data, offset %d and size %d are too big", offset, size);
        return;
    }

    for (size_t i = 0; i < size; i++) {
        data[i] = flash_read_8_bits(nvs_page_start + offset + i);
    }
}

//------------------------------------------------------------------------------
// Module static functions
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
